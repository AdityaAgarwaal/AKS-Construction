name: Deploy AKS-Construction

on:
  workflow_call:
    inputs:
      templateVersion:
        description: 'Template Version'
        required: false
        default: '0.8.5-preview'
        type: string
      rg:
        description: 'ResourceGroup name'
        required: true
        type: string
      resourceName:
        description: 'Unique name all your resources are based on'
        required: true
        type: string
      agentCount:
        description: 'agentCount'
        required: false
        default: 2
        type: number
      upgradeChannel:
        description: 'upgradeChannel'
        required: false
        type: string
      JustUseSystemPool:
        description: 'Use a single nodepool for system and user workloads'
        required: false
        type: boolean
        default: false
      custom_vnet:
        description: 'Create a custom VNET'
        required: false
        default: false
        type: boolean
      CreateNetworkSecurityGroups:
        description: 'CreateNetworkSecurityGroups'
        required: false
        default: false
        type: boolean
      enable_aad:
        description: 'enable_aad'
        required: false
        default: false
        type: boolean
      AksDisableLocalAccounts:
        description: 'AksDisableLocalAccounts'
        required: false
        default: false
        type: boolean
      enableAzureRBAC:
        description: 'enableAzureRBAC'
        required: false
        default: false
        type: boolean
      adminPrincipalId:
        description: 'adminPrincipalId'
        required: false
        type: string
      registries_sku:
        description: 'registries_sku'
        required: false
        type: string
      acrPushRolePrincipalId:
        description: 'acrPushRolePrincipalId'
        required: false
        type: string
      azurepolicy:
        description: 'azurepolicy'
        required: false
        type: string
      dnsZoneId:
        description: 'dnsZoneId'
        required: false
        type: string
      azureKeyvaultSecretsProvider:
        description: 'azureKeyvaultSecretsProvider'
        required: false
        default: false
        type: boolean
      createKV:
        description: 'createKV'
        required: false
        default: false
        type: boolean
      kvOfficerRolePrincipalId:
        description: 'kvOfficerRolePrincipalId'
        required: false
        type: string
      monitor:
        description: 'monitor'
        required: false
        type: string
      ingress:
        description: 'ingress'
        required: false
        type: string
      certEmail:
        description: 'certEmail'
        required: false
        type: string
      enableMonitorIngress:
        description: 'enableMonitorIngress'
        required: false
        type: boolean
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true
      USER_OBJECT_ID:
        required: false

permissions:
  id-token: write
  contents: read

jobs:
  aksc_reusable_workflow:
    runs-on: ubuntu-latest
    steps:
      # Log into Azure
    - uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Deploy Bicep file
    - name: Deploy Bicep
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        resourceGroupName: ${{ inputs.rg }}
        template: https://github.com/Azure/AKS-Construction/releases/download/${{ inputs.templateVersion }}/main.json
        parameters: 	automatedDeployment=true resourceName=${{ inputs.resourceName }} agentCount=${{ inputs.agentCount }} upgradeChannel=${{ inputs.upgradeChannel}} JustUseSystemPool=${{ inputs.JustUseSystemPool }} custom_vnet=${{ inputs.custom_vnet }} CreateNetworkSecurityGroups=${{ inputs.CreateNetworkSecurityGroups }} enable_aad=${{ inputs.enable_aad }} AksDisableLocalAccounts=${{ inputs.AksDisableLocalAccounts }} enableAzureRBAC=${{ inputs.enableAzureRBAC }} adminPrincipalId=${{ secrets.USER_OBJECT_ID }} registries_sku=${{ inputs.registries_sku }} acrPushRolePrincipalId=${{ secrets.USER_OBJECT_ID }} azurepolicy=${{ inputs.azurepolicy }} dnsZoneId=${{ inputs.dnsZoneId }} azureKeyvaultSecretsProvider=${{ inputs.azureKeyvaultSecretsProvider }} createKV=${{ inputs.createKV }} kvOfficerRolePrincipalId=${{ secrets.USER_OBJECT_ID }}
        failOnStdErr: false


    - name: Kubelogin
      env:
        kubeloginversion: 'v0.0.12'
      run: |

        az aks get-credentials -n aks-${{ inputs.resourceName }} -g ${{ inputs.rg }} --overwrite-existing

        wget https://github.com/Azure/kubelogin/releases/download/v0.0.13/kubelogin-linux-amd64.zip
        unzip kubelogin-linux-amd64.zip
        sudo mv bin/linux_amd64/kubelogin /usr/bin
        kubelogin convert-kubeconfig -l azurecli


    - name: Post Deploy
      run: |
        curl -sL https://github.com/Azure/AKS-Construction/releases/download/${{ inputs.templateVersion }}/postdeploy.sh | bash -s -- -r https://github.com/Azure/AKS-Construction/releases/download/${{ inputs.templateVersion }} -p KubeletId=$(az aks show -n aks-${{ inputs.resourceName }} -g ${{ inputs.rg }} --query identityProfile.kubeletidentity.clientId -o tsv),TenantId=${{ secrets.AZURE_TENANT_ID }},ingress=${{ inputs.ingress }},monitor=${{ inputs.monitor }},enableMonitorIngress=${{ inputs.enableMonitorIngress }},ingressEveryNode=${{ inputs.ingressEveryNode }},dnsZoneId=${{ inputs.dnsZoneId }},certEmail=${{ inputs.certEmail }}
